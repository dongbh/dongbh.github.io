## dali 快速配置工具

DALI Configurator 是一款支持 DALI2 的快速设置工具（以下简称设备）， 用于便捷设置短地址、分组， 配置场景等信息。

### 主要特点

- dali2协议，支持短地址扫描、分配、全部初始化等功能；
- 处理器为eps32，资源充足、省电环保；
- 自带管理界面，直观寻灯、分组和控制，调试方便；
- 220v误接保护，工程适用；
- 内置dail电源，也可以使用外部dali电源；
- 供电为通用的typec接口，可以用充电宝或充电器（5v2A）供电，同时pd供电（最高12v)。

### 接口说明
- type-c插座：设备供电；
- DALI接线（远离拨动开关）： 连接DALI总线；
- PSU 接线（靠近拨动开关）： 外接DALI电源（可选）；
- led指示灯：
    - WIFI：闪烁或熄灭表示未连接，常亮表示wifi已连接，并获取IP地址。
    - RX: 闪亮表示正在从总线接收数据，无接收熄灭
    - TX：闪亮表示正在向总线发送数据，无发送熄灭 
    - AP：闪烁或熄灭表示未连接，常亮表示已启用AP服务， 其他设备通过d2m-xxxxxx的ssid接入， 此时设备地址为192.168.4.1。 
    
![体积小巧](/res/dalitool.png)

### 使用方法
1. 先将设备接入dail总线，插上typec电源；
2. 等待设备获取ip地址（wifi led常亮)，从浏览器上访问设备：http://d2m.local；也可以从路由器上查看获取的地址，以下假设获取的地址为 192.168.1.99；
3. 如果是首次使用，则设备在无法接入wifi热点后，启用 AP 模式，此时 AP 指示灯常亮，热点名字为 d2m-xxxxxxx(后缀为此设备的mac地址)，密码为 1234567890，手机/平板可以直接搜索接入（此时设备地址为192.168.4.1, 不可以用d2m访问）；
4. 在浏览器里输入设备的ip址址，系统出提示用户名和密码，输入用户名 d2m 和 密码 dali2mqtt，进入配置页面，配置提交后设备会重启；
5. 多功能键操作：
    - 单击：用于在全开和全关之间来回切换，按一下全开，再按全关；
    - 双击：用于扫描总线上的灯具，同时向mqtt服务㗊上报结果，可以多次扫描更新；
    - 长按（2秒以上，5秒以下）：对新灯具分配短地址；
    - 长按（6秒以上）：删除所有已分配的地址；
    - 长按（15秒以上）：临时初始化web登录密码为 dali2mqtt；
6. 拨动开关操作：
    - 拨向内侧：使用内部自带的dali电源；
    - 拨向内侧：使用外部dali电源；


### 设备管理界面操作
1. 进入管理界面：在同一网络下的电脑或手机的浏览器里输入设备地址，如 http://d2m.local 或 http://192.168.1.99, 打开设备管理页面(用户名为 d2m，初始密码为 dali2mqtt);
2. 配置管理：选择"配置"，进入配置页面：
    - 网络参数：可设置静态地址和wifi等参数，缺省状态下是DHCP获取地址；
    - mqtt 服务器：无需设置
    - 设备参数：设置设备的名称（显示在web页面）和web密码（6字符以上，如为空白则为初始密码dali2mqtt，用户名为d2m）；
    - 配置文件：下载配置是将所有的配置可以下载成 json 文件，用于备份；恢复配置用于将备份的配置恢复到设备，请先选择备份文件名；
3. 灯具操作：选择"灯控"，进入灯具控制页面。页面会显示扫描后发现的所有灯具和分组信息：
    - 单击短地址进入找灯模式，此灯闪烁10秒钟；
    - 双击短地址可以更改地址；
    - 双击灯具名字可以更改名字；
    - 直接点击某灯具的分组编号即可将其加入或离开这一分组；
    - 滑动亮度或色温滑块可以直接控制灯具的亮度和色温；
4. 分组操作：选择"组控"，进入分组控制页面：
    - 单击短地址进入找灯模式，此组所有灯闪烁10秒钟；
    - 双击组名可以更改名字；
    - 双击类型可以更改灯具类型（255为双色温）;
    - 滑动亮度或色温滑块可以直接控制灯具的亮度和色温；
    - 直接点击组内某灯具编号即可将其加入或离开这一分组；
5. 灯具配置：选择"灯具"页面，选择某一灯具后（需要单击 保存 才能保存到设备和灯具）：
    - 可以输入渐变速率和渐变时间；
    - 可以读出设备缓存的场景数据，或直接输入后保存到设备和灯具；
6. 常用命令：选择"命令"页面：
    - 全部打开：切换所有灯具全开亮度（100%）；
    - 全部关闭：切换所有灯具全关亮度（0%）；
    - 闪烁寻灯：用于灯具定位，相应灯具会闪烁10秒钟，短地址有效值为0-79，其中64-79表示组0到组15；
    - 扫描设备 ：扫描总线上所有短地址，并上传到mqtt服务器；
    - 同步已发现设备：无操作
    - 为新设备分配地址: 为新灯具分配短地址（已分配短地址的不受影响）；
    - 删除地址：用于删除某一地址（需要根据提示输入后确认），短地址有效值为0-63；
    - 删除所有地址：删除所有短地址，然后可以重新分配（需要根据提示输入后确认）；
    - 设备初始化：删除网络所有配置后重启（需要根据提示输入后确认），灯具不受影响；
6. 固件管理：选择"固件"页面后：
    - 在线升级：如有新固件，系统在升级后会重启；如果没有新固件；会提示不需要升级；

### 网络
1. 开机时首先开启wifi sta 模式，寻找ap并接入；
3. 如果5次尝试仍不能接入ap，则自动开启 ap 模式，其wifi ssid 以 d2m- 开头后跟 mac 地址，如 d2m-c049ef3f40b4，密码为1234567890；

### 其他说明
1. web 初始访问用户名为 d2m，密码为 dali2mqtt；ap模式下， ssid 为 d2m-xxxxxxxx(mac地址)，密码为1234567890 或 dali2mqtt;
2. 鼠标悬停在命令/短地址等上面会有提示信息；
3. 设备进行扫描时，将扫描发现的设备信息同步保存到设备，如果有灯具未被发现，可能需要多次扫描；
4. 由于dali系统短地址随机分配，删除后再分配的短地址会和原来不一致，建议删除功能慎用；
5. 无网络情况下，可以直接使用多功能键进行操作；
6. 设备采用 esp32 模组，每个模组有4个mac地址（wifi, ap， bluetooth, ethernet)，设备配置中的mac是wifi的mac,所以当接入有线网络时，和路由器上发现的mac并不一致；
7. 设备提供总线电源，但禁止长时间短路。